name: Master Terraform Monitor

on:
  schedule:
    - cron: '0 5 * * *'  # ×›×œ ×™×•× ×‘Ö¾05:00 UTC
  workflow_dispatch:

jobs:
  run-and-monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install curl jq -y

      - name: ğŸ“¤ ×”×¤×¢×œ×ª TerraformPlan-DRIFTChecker.yml
        id: trigger
        run: |
          echo "ğŸ“¤ ××¤×¢×™×œ TerraformPlan-DRIFTChecker.yml ×•×©×•××¨ ×–××Ÿ ×”×ª×—×œ×”..."
          start_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "start_time=$start_time" >> $GITHUB_ENV

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/TerraformPlan-DRIFTChecker.yml/dispatches \
            -d '{"ref":"main"}'

          echo "â³ ×××ª×™×Ÿ 10 ×©× ×™×•×ª ×©×”×¨×™×¦×” ×ª×ª×—×™×œ..."
          sleep 10

      - name: ğŸ” ××¦×™××ª Run ×”××—×¨×•×Ÿ ×©×œ ×”-Workflow
        id: find-run
        run: |
          echo "ğŸ” ××—×¤×© run ×©× ×•×¦×¨ ××—×¨×™: $start_time"
          for i in {1..5}; do
            echo "âŒ› × ×™×¡×™×•×Ÿ $i..."
            runs=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/TerraformPlan-DRIFTChecker.yml/runs?branch=main")

            run_id=$(echo "$runs" | jq -r --arg start "$start_time" '.workflow_runs[] | select(.created_at > $start) | .id' | head -n 1)

            if [ -n "$run_id" ]; then
              echo "âœ… × ××¦× run_id: $run_id"
              echo "run_id=$run_id" >> $GITHUB_OUTPUT
              break
            fi

            echo "â³ ×œ× × ××¦× ×¢×“×™×™×Ÿ... ××—×›×” 5 ×©× ×™×•×ª"
            sleep 5
          done

          if [ -z "$run_id" ]; then
            echo "âŒ ×œ× ×”×¦×œ×—×ª×™ ×œ××¦×•× run ×©× ×•×¦×¨ ××—×¨×™ ×”×”×¤×¢×œ×”"
            exit 1
          fi

      - name: â± ××¢×§×‘ ××—×¨×™ ×¡×˜×˜×•×¡ ×”×¨×™×¦×”
        id: poll
        run: |
          run_id=${{ steps.find-run.outputs.run_id }}
          echo "ğŸ” ×¢×•×§×‘ ××—×¨×™ ×¡×˜×˜×•×¡ ×©×œ run_id=$run_id"

          for i in {1..5}; do
            echo "âŒ› ×‘×“×™×§×” #$i..."

            result=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id)

            status=$(echo "$result" | jq -r '.status')
            conclusion=$(echo "$result" | jq -r '.conclusion')

            echo "ğŸ“˜ Status: $status | Conclusion: $conclusion"

            if [ "$status" == "completed" ]; then
              echo "status=$status" >> $GITHUB_OUTPUT
              echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
              break
            fi

            sleep 15
          done

      - name: âŒ ×›×™×©×œ×•×Ÿ ×‘×ª×”×œ×™×š
        if: ${{ steps.poll.outputs.conclusion != 'success' }}
        run: |
          echo "âŒ ×”×¤×™×™×¤×œ×™×™×Ÿ 'TerraformPlan-DRIFTChecker.yml' × ×›×©×œ!"
          exit 1

      - name: âœ… ×”×¦×œ×—×” ×‘×ª×”×œ×™×š
        if: ${{ steps.poll.outputs.conclusion == 'success' }}
        run: |
          echo "âœ… ×”×¤×™×™×¤×œ×™×™×Ÿ TerraformPlan-DRIFTChecker.yml ×”×¦×œ×™×—!"

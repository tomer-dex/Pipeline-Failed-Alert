name: Master Terraform Monitor

on:
  schedule:
    - cron: '0 5 * * *'  # ×›×œ ×™×•× ×‘×©×¢×” 05:00 UTC
  workflow_dispatch:

jobs:
  run-and-monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install curl jq -y

      - name: Trigger blank workflow
        id: trigger
        run: |
          echo "ğŸ“¤ ×©×•×œ×— dispatch ×œ×”×¤×¢×œ×ª blank.yml..."

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${{ secrets.GH_PAT_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/blank.yml/dispatches \
            -d '{"ref":"main"}'

          echo "â³ ×××ª×™×Ÿ ×œ×™×¦×™×¨×ª run..."
          sleep 10

          echo "ğŸ” ×××ª×¨ ××ª ×”-run_id ×”××—×¨×•×Ÿ..."
          run_id=$(curl -s -H "Authorization: token ${{ secrets.GH_PAT_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/blank.yml/runs?branch=main \
            | jq '.workflow_runs[0].id')

          echo "âœ… run_id ×©× ××¦×: $run_id"
          echo "run_id=$run_id" >> $GITHUB_OUTPUT

      - name: Poll run status
        id: poll
        run: |
          run_id=${{ steps.trigger.outputs.run_id }}
          echo "ğŸ” ×¢×•×§×‘ ××—×¨×™ ×¡×˜×˜×•×¡ ×©×œ run_id=$run_id"

          for i in {1..10}; do
            echo "âŒ› ×‘×“×™×§×” #$i..."

            result=$(curl -s -H "Authorization: token ${{ secrets.GH_PAT_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id)

            status=$(echo "$result" | jq -r '.status')
            conclusion=$(echo "$result" | jq -r '.conclusion')

            echo "ğŸ“˜ Status: $status | Conclusion: $conclusion"

            if [ "$status" == "completed" ]; then
              echo "status=$status" >> $GITHUB_OUTPUT
              echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
              break
            fi

            sleep 15
          done

      - name: Print failure message if run failed
        if: ${{ steps.poll.outputs.conclusion != 'success' }}
        run: |
          echo "âŒ ×”×¤×™×™×¤×œ×™×™×Ÿ 'blank.yml' × ×›×©×œ!"
          echo "Conclusion: ${{ steps.poll.outputs.conclusion }}"
          exit 1  # ××¡××Ÿ ××ª ×”Ö¾master pipeline ×›×›×™×©×œ×•×Ÿ

      - name: Print success message
        if: ${{ steps.poll.outputs.conclusion == 'success' }}
        run: echo "âœ… ×”×¤×™×™×¤×œ×™×™×Ÿ blank.yml ×”×¦×œ×™×—"

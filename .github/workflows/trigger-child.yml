name: Master Terraform Monitor

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  run-and-monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install curl jq unzip -y

      - name: ğŸ“¤ Trigger deploy.yml
        id: trigger
        run: |
          echo "start_time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/dispatches \
            -d '{"ref":"main"}'

          echo "â³ Waiting for run to begin..."
          sleep 10

      - name: ğŸ” Find latest workflow run
        id: find-run
        run: |
          for i in {1..5}; do
            runs=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/runs?branch=main")

            run_id=$(echo "$runs" | jq -r --arg start "$start_time" '
              .workflow_runs[] | select(.created_at > $start) | .id' | head -n 1)

            if [ -n "$run_id" ]; then
              echo "run_id=$run_id" >> $GITHUB_OUTPUT
              break
            fi

            echo "âŒ› Waiting for run to be available..."
            sleep 5
          done

          if [ -z "$run_id" ]; then
            echo "âŒ Failed to locate a matching run"
            exit 1
          fi

      - name: â± Poll run status
        id: poll
        run: |
          run_id=${{ steps.find-run.outputs.run_id }}

          for i in {1..10}; do
            result=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id)

            status=$(echo "$result" | jq -r '.status')
            conclusion=$(echo "$result" | jq -r '.conclusion')

            echo "Status: $status | Conclusion: $conclusion"

            if [ "$status" = "completed" ]; then
              echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
              break
            fi

            sleep 10
          done

      - name: ğŸ“¥ Download logs
        if: ${{ steps.poll.outputs.conclusion != '' }}
        run: |
          run_id=${{ steps.find-run.outputs.run_id }}
          curl -s -L -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -o logs.zip \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id/logs
          unzip -o logs.zip -d logs
          find logs

      - name: ğŸ“© Open ticket in Freshservice
  if: ${{ steps.diff-check.outputs.drift_detected == 'true' }}
  shell: bash
  run: |
    echo "ğŸ“¨ Opening ticket in Freshservice..."

    # ×§×¨×™××” ××”×§×•×‘×¥, ×”××¨×ª ×’×¨×©×™×™× ×•×™×¨×™×“×•×ª ×©×•×¨×”
    DRIFT_BODY=$(cat drift_details.txt | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

    echo "ğŸ“„ Formatted drift body:"
    echo "$DRIFT_BODY"

    # ×‘× ×™×™×ª JSON ×ª×§× ×™
    JSON_PAYLOAD=$(cat <<EOF
{
  "subject": "ğŸš¨ Terraform Drift Detected",
  "description": "$DRIFT_BODY",
  "email": "tomer@direct-ex.co.il",
  "priority": 1,
  "status": 2
}
EOF
)

    echo "ğŸ“¦ Payload to send:"
    echo "$JSON_PAYLOAD"

    # ×©×œ×™×—×” ×‘×¤×•×¢×œ + ×“×™×‘×•×’ ×ª×©×•×‘×”
    RESPONSE=$(curl -s -w "\nğŸ”¢ HTTP status: %{http_code}\n" -o response.json -X POST "https://directex.freshservice.com/api/v2/tickets" \
      -H "Content-Type: application/json" \
      -H "Authorization: Basic ${{ secrets.FRESHDESK_API_KEY }}" \
      -d "$JSON_PAYLOAD")

    echo "$RESPONSE"
    echo "ğŸ“„ API response body:"
    cat response.json


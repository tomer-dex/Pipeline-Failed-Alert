name: Master Terraform Monitor

on:
  schedule:
    - cron: '0 5 * * *'  # ×›×œ ×™×•× ×‘Ö¾05:00 UTC
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  run-and-monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install curl jq unzip -y

      - name: ðŸ“¤ Trigger TerraformPlan-DRIFTChecker.yml
        id: trigger
        run: |
          echo "ðŸ“¤ Triggering child workflow and saving start time..."
          start_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "start_time=$start_time" >> $GITHUB_ENV

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/TerraformPlan-DRIFTChecker.yml/dispatches \
            -d '{"ref":"main"}'

          echo "â³ Waiting for run to begin..."
          sleep 10

      - name: ðŸ” Find latest run
        id: find-run
        run: |
          echo "ðŸ” Looking for workflow run after $start_time..."
          for i in {1..5}; do
            runs=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/workflows/TerraformPlan-DRIFTChecker.yml/runs?branch=main")
            run_id=$(echo "$runs" | jq -r --arg start "$start_time" '.workflow_runs[] | select(.created_at > $start) | .id' | head -n 1)
            if [ -n "$run_id" ]; then
              echo "run_id=$run_id" >> $GITHUB_OUTPUT
              break
            fi
            echo "âŒ› Not found yet... waiting"
            sleep 5
          done

          if [ -z "$run_id" ]; then
            echo "âŒ Failed to locate workflow run"
            exit 1
          fi

      - name: â± Poll workflow run status
        id: poll
        run: |
          run_id=${{ steps.find-run.outputs.run_id }}
          for i in {1..10}; do
            result=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id)
            status=$(echo "$result" | jq -r '.status')
            conclusion=$(echo "$result" | jq -r '.conclusion')
            echo "Status: $status | Conclusion: $conclusion"
            if [ "$status" == "completed" ]; then
              echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
              break
            fi
            sleep 10
          done

      - name: ðŸ“¥ Download workflow logs
        if: ${{ steps.poll.outputs.conclusion != '' }}
        run: |
          run_id=${{ steps.find-run.outputs.run_id }}
          curl -s -L -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -o logs.zip \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/$run_id/logs
          unzip -o logs.zip -d logs
          find logs

      - name: ðŸ” Check for drift in Terraform plan
        id: diff-check
        run: |
          PLAN_FILE=$(find logs -type f -iname "*Terraform Plan.txt" | head -n 1)
          echo "Plan file: $PLAN_FILE"
          
          if [ -z "$PLAN_FILE" ]; then
            echo "âŒ Plan output file not found"
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ðŸ“„ Terraform plan output:"
          cat "$PLAN_FILE"

          if grep -q 'No changes. Infrastructure is up-to-date.' "$PLAN_FILE"; then
            echo "âœ… No drift detected"
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Drift detected!"
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "drift_details<<EOF" >> $GITHUB_OUTPUT
            cat "$PLAN_FILE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“© Create Freshservice ticket
        if: ${{ steps.diff-check.outputs.drift_detected == 'true' }}
        run: |
          echo "ðŸ“¨ Creating ticket in Freshservice..."
          curl -s -X POST "https://directex.freshservice.com/api/v2/tickets" \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic ${{ secrets.FRESHDESK_API_KEY }}" \
            -d "{
              \"subject\": \"ðŸš¨ DRIFT Detected in Terraform\",
              \"description\": \"The following infrastructure drift was detected:\n\n${{ steps.diff-check.outputs.drift_details }}\",
              \"email\": \"tomer@direct-ex.co.il\",
              \"priority\": 1,
              \"status\": 2
            }"
          echo "ðŸŽ« Ticket sent."

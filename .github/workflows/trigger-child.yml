name: Master Terraform Monitor

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  run-and-monitor:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4
        
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install curl jq gh unzip -y
          
      - name: âš™ï¸ Configure GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh auth status
          
      - name: ðŸ“¤ Trigger deploy.yml
        id: trigger
        run: |
          gh workflow run deploy.yml --ref main
          echo "start_time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV #create start time var to know what is the specific time that the deploy.yml is ru
          sleep 10

      - name: ðŸ” Find latest workflow run
        id: find-run
        run: |
          echo "ðŸ”Ž Searching for latest deploy.yml run..."
          run_id=$(gh run list \
            --workflow deploy.yml \
            --branch main \
            --json databaseId,createdAt \
            --jq ".[] | select(.createdAt > \"${start_time}\") | .databaseId" | head -n 1)

          if [ -z "$run_id" ]; then
            echo "âŒ No matching run found"
            exit 1
          fi

          echo "âœ… Found run ID: $run_id"
          echo "run_id=$run_id" >> $GITHUB_OUTPUT

      - name: â± Wait for deploy.yml run to complete
        id: poll
        run: |
          run_id=${{ steps.find-run.outputs.run_id }}
          echo "ðŸ” Waiting for deploy.yml run (ID: $run_id)..."
    
          # ×ž×—×›×” ×©×”×¨×™×¦×” ×ª×¡×ª×™×™× ×•×ž×“×¤×™×¡×” ××ª ×”×œ×•×’×™× ×‘×–×ž×Ÿ ××ž×ª
          gh run watch $run_id --exit-status

          # ×× ×”×’×¢× ×• ×œ×¤×”, ×–×” ××•×ž×¨ ×©×”×¨×™×¦×” ×”×¡×ª×™×™×ž×” ×‘×”×¦×œ×—×”
          echo "âœ… Deploy workflow completed successfully!"

      - name: ðŸ” Extract Terraform plan from deploy.yml logs
        id: extract-plan
        run: |
          run_id=${{ steps.find-run.outputs.run_id }}
          echo "ðŸ“– Fetching logs for run ID: $run_id..."

          # ×©×œ×™×¤×ª ×›×œ ×”×œ×•×’×™× ×‘×¤×•×¨×ž×˜ ×˜×§×¡×˜
          LOG_CONTENT=$(gh run view $run_id --log)

          # ×©×ž×™×¨×ª ×”×œ×•×’ ×”×ž×œ× ×›-reference
          echo "$LOG_CONTENT" > full_log.txt

          echo "ðŸ” Searching for Terraform plan output..."
          PLAN_OUTPUT=$(echo "$LOG_CONTENT" | awk '/Terraform will perform the following actions:/,/Plan: [0-9]+ to add/')

          if [ -z "$PLAN_OUTPUT" ]; then
            echo "âœ… No Terraform drift detected"
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Drift detected"
            echo "$PLAN_OUTPUT" > drift_details.txt
            echo "drift_detected=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

        
      - name: ðŸ“© Open ticket in Freshservice
        if: ${{ steps.extract-plan.outputs.drift_detected == 'true' }}
        shell: bash
        run: |
          echo "ðŸ“¨ Opening ticket in Freshservice..."
      
          # ×—×™×œ×•×¥ ×•× ×™×§×•×™ ×©×œ ×ª×•×›×Ÿ ×”-terraform plan
          awk '/Terraform will perform the following actions:/,/Note: You/' drift_details.txt > raw_plan.txt
          awk '{ if ($1 == "terraform-plan") {$1=$2=$3=""; sub(/^   */, ""); print} else {print} }' raw_plan.txt > clean_plan.txt
          sed -i -E 's/[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}\.[0-9]+Z[[:space:]]*//g' clean_plan.txt
          sed -i -r "s/\x1B\[[0-9;]*[A-Za-z]//g" clean_plan.txt
      
          # ×”×¤×™×›×ª ×”×¤×œ×˜ ×œ×ž×—×¨×•×–×ª JSON ×—×•×§×™×ª
          ESCAPED_BODY=$(jq -Rs . < clean_plan.txt)
      
          # ×‘× ×™×™×ª ×’×•×£ ×”×‘×§×©×” ×‘×“×™×•×§ ×›×ž×• ×‘-Elastic
          cat <<EOF > payload.json
          {
            "short_description": "ðŸš¨ Terraform Drift Detected",
            "description": $ESCAPED_BODY,
            "severity": "warning",
            "Metric_Name": "Terraform Drift",
            "Metric_Value": "Detected Changes",
            "Resource": "Infrastructure - Terraform"
          }
          EOF
      
          echo "ðŸ“„ Payload:"
          cat payload.json
      
          # ×©×œ×™×—×” ×œ-Freshservice API
          curl -s -X POST "https://directex.freshservice.com/api/v2/tickets" \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic ${{ secrets.FRESHDESK_API_KEY }}" \
            -d @payload.json
